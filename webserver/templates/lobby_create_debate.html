{% extends 'layout/body.html' %}

{% block title %} AI Agora Lobby {% endblock %}


{% block content %}
    <div class="content-container">
        <h1> </h1>
        <div class="container">
            <form action="{{ request.url_for('create_debate') }}" id="debateForm" method="post">
                <div class="row">
                    <div class="col-sm-2"></div>
                    <div class="col-sm-4">
                        <label for="pos">찬성 측 AI:</label>
                        <select id="pos" name="pos">  
                            {% for id, data in profiles.items() %}
                            {% set profile = data.data %}
                                <option value="{{ profile._id }}"> {{ profile.name }} - {{ profile.ai }} </option>
                            {% endfor %}
                        </select>
                        
                    </div>
                    <div class="col-sm-4">
                        <label for="neg">반대 측 AI:</label>
                        <select id="neg" name="neg">  
                            {% for id, data in profiles.items() %}
                            {% set profile = data.data %}
                                <option value="{{ profile._id }}"> {{ profile.name }} - {{ profile.ai }} </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-2"></div>
                </div>
                <div class="row">
                    <div class="col-sm-2"></div>
                    <div class="form-group col-sm-8">
                        <label for="topic"></label>
                        <input class="form-control" type="text" id="topic" name="topic" placeholder="주제 입력">
                    </div>
                    <div class="col-sm-2"></div>
                </div>
                <button type="submit">시작하기</button>
            </form>
            <script>
                document.getElementById("debateForm").addEventListener("submit", async function(event) {
                event.preventDefault(); // 기본 제출 동작 방지
                
                if (document.getElementById("pos").value === document.getElementById("neg").value) {
                    alert("같은 AI를 중복으로 선택할 수 없습니다.");
                    return;
                }

                const formData = new FormData(event.target); // 폼 데이터 가져오기
                const actionUrl = event.target.action; // form의 action URL 가져오기

                try {
                    const response = await fetch(actionUrl, {
                        method: "POST",
                        body: formData // FormData를 그대로 전송
                    });

                    if (!response.ok) {
                        throw new Error("서버 응답 실패");
                    }

                    const result = await response.json(); // JSON으로 응답 받기
                    console.log("토론 생성 성공:", result);

                    if (result.id) {
                        window.location.href = `/debate/?id=${result.id}`; // 받은 ID로 페이지 이동
                    } else {
                        alert("토론 ID를 받아올 수 없습니다.");
                    }
                } catch (error) {
                    console.error("에러 발생:", error);
                    alert("토론 생성 중 오류가 발생했습니다.");
                }
            });
            </script>
        </div>
    </div>
{% endblock %}